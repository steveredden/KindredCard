{{define "util_body"}}
<div class="w-full max-w-6xl px-4 mx-auto pb-20">

    <div class="flex items-center justify-between mb-8">
        <a href="/utilities/immich-link" class="btn btn-ghost btn-sm">‚Üê Back to Linker</a>
    </div>

    <div class="bg-base-100 border-2 border-base-300 rounded-[3rem] overflow-hidden shadow-[0_35px_60px_-15px_rgba(0,0,0,0.1)]">
        <table class="table w-full border-separate border-spacing-0">
            <thead>
                <tr class="bg-base-200/80">
                    <th class="py-8 pl-12 text-sm uppercase tracking-[0.3em] font-black opacity-70">KindredCard Contact</th>
                    <th class="py-8 text-center text-sm uppercase tracking-[0.3em] font-black opacity-70">Sync Health</th>
                    <th class="py-8 text-sm uppercase tracking-[0.3em] font-black opacity-70">
                        <span class="flex items-center justify-left gap-3">
                            <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 fill-current">
                                <path d="M11.9863 0.2695c-2.409 0 -5.207 1.091 -5.207 3.8946v0.1523c1.3428 0.597 2.9347 1.6629 4.4121 2.9707 1.5713 1.3912 2.8374 2.8821 3.6524 4.2871 1.3997 -2.5034 2.3358 -5.4784 2.3476 -7.373V4.164c0 -2.8035 -2.796 -3.8946 -5.205 -3.8946m7.5117 4.4903c-0.3778 -0.0081 -0.7747 0.0502 -1.1914 0.1855 -0.0366 0.0118 -0.086 0.0278 -0.1445 0.0469 -0.1525 1.4611 -0.6756 3.304 -1.4629 5.1133 -0.8373 1.9243 -1.8627 3.5898 -2.9472 4.7988 2.8132 0.558 5.9307 0.5273 7.7363 -0.0469 0.0126 -0.004 0.0246 -0.0065 0.0351 -0.0097 2.6665 -0.8666 2.84 -3.8636 2.0957 -6.1543 -0.6279 -1.9332 -2.081 -3.89 -4.121 -3.9336m-14.996 0.039C2.4618 4.8424 1.0088 6.7973 0.3809 8.7305c-0.7442 2.291 -0.5708 5.288 2.0957 6.1543l0.1445 0.0468c0.982 -1.0926 2.4873 -2.2761 4.1875 -3.2773 1.8088 -1.0646 3.619 -1.808 5.207 -2.1484 -1.9483 -2.1049 -4.4884 -3.9132 -6.287 -4.5098l-0.0352 -0.0117c-0.4167 -0.1354 -0.8136 -0.1936 -1.1914 -0.1856m4.6718 6.7578c-2.6038 1.2025 -5.1088 3.0598 -6.2324 4.586l-0.0215 0.0293c-1.6478 2.2683 -0.0272 4.7953 1.9219 6.211 1.9487 1.4159 4.8518 2.1765 6.5 -0.0919 0.0228 -0.0309 0.0536 -0.071 0.0898 -0.121 -0.7356 -1.2717 -1.396 -3.0718 -1.8222 -4.9981 -0.4534 -2.0492 -0.6023 -4 -0.4356 -5.6153m1.0723 3.338c0.3387 2.8478 1.3315 5.8037 2.4355 7.3437l0.0215 0.0293c1.6478 2.2683 4.551 1.5078 6.5 0.0918 1.9487 -1.416 3.5697 -3.943 1.9219 -6.211 -0.0228 -0.0309 -0.0517 -0.073 -0.0879 -0.123 -1.4367 0.3066 -3.3522 0.3794 -5.3164 0.1894 -2.089 -0.2017 -3.9895 -0.6623 -5.4746 -1.3203" />
                            </svg>
                            Immich Person
                        </span>
                    </th>
                    <th class="py-8 pr-12 text-right text-sm uppercase tracking-[0.3em] font-black opacity-70">Control</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-base-300">
                {{range .Items}}
                <tr class="group hover:bg-primary/5 transition-all duration-200">
                    <td class="py-8 pl-8">
                        <div class="flex items-center gap-5">
                            <div class="indicator">
                                {{if not .Contact.AvatarBase64}}
                                <span class="indicator-item badge badge-warning badge-lg border-white ring-2 ring-white animate-pulse">!</span> 
                                {{end}}
                                <a target="_blank" href="/contacts/{{.Contact.ID}}">
                                <div class="avatar {{if not .Contact.AvatarBase64}}placeholder{{end}}">
                                    <div class="w-16 h-16 rounded-2xl border-2 border-base-300 shadow-sm group-hover:border-primary/30 transition-colors">
                                        {{if .Contact.AvatarBase64}}
                                            <img src="data:{{.Contact.AvatarMimeType}};base64,{{.Contact.AvatarBase64}}" />
                                        {{else}}
                                            <span class="text-2xl font-black bg-base-300 text-base-content/40 w-full h-full flex items-center justify-center uppercase">
                                                {{initial .Contact.FullName}}
                                            </span>
                                        {{end}}
                                    </div>
                                </div>
                                </a>
                            </div>
                            <div class="ml-2">
                                <div class="font-black text-lg"><a class="link" target="_blank" href="/contacts/{{.Contact.ID}}">{{.Contact.FullName}}</a></div>
                                <div class="text-sm font-bold opacity-40 tracking-tighter">
                                    {{if .Contact.Birthday}}{{.Contact.Birthday.Format "2006-01-02"}}{{else}}No Birthday Saved{{end}}
                                </div>
                            </div>
                        </div>
                    </td>

                    <td class="text-center">
                        <div class="flex flex-col items-center gap-2">
                            {{/* 1. MISSING STATES (The Action Items) */}}
                            {{if not .Contact.AvatarBase64}}
                                <div class="badge badge-warning text-[12px] font-black uppercase py-3 px-4 shadow-sm border-none text-black">
                                    Photo Missing
                                </div>
                            {{end}}

                            {{if and .ImmichPerson.BirthDate (not .Contact.Birthday)}}
                                <div class="badge badge-error text-[12px] font-black uppercase py-3 px-4 shadow-sm border-none">
                                    Birthday Sync
                                </div>
                            {{end}}

                            {{/* 2. SYNCED STATES (The Status Indicators) */}}
                            
                            {{/* Case A: Fully Synced (Both Avatar and Birthday exist) */}}
                            {{if and .Contact.AvatarBase64 .Contact.Birthday}}
                                <div class="tooltip tooltip-primary" data-tip="Avatar & Birthday Synced">
                                    <div class="w-10 h-10 rounded-full bg-success/20 flex items-center justify-center text-success shadow-inner">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                    </div>
                                </div>

                            {{/* Case B: Avatar Synced, No Birthday available on either side */}}
                            {{else if and .Contact.AvatarBase64 (not .ImmichPerson.BirthDate)}}
                                <div class="tooltip tooltip-primary" data-tip="Avatar Synced (No Birthday Found)">
                                    <div class="opacity-80 text-success">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M20 6 9 17l-5-5"/>
                                        </svg>
                                    </div>
                                </div>
                            {{end}}
                        </div>
                    </td>

                    <td class="py-8">
                        <div class="flex items-center gap-5 opacity-90 group-hover:opacity-100 transition-opacity">
                            <div class="avatar">
                                <div class="w-16 h-16 rounded-2xl border-2 border-base-300 shadow-sm ring-offset-2 group-hover:ring-2 ring-primary/20">
                                    <a class="link" target="_blank" href="{{$.Base}}/people/{{.ImmichPerson.ID}}">
                                        <img class="immich-avatar-img" src="/api/v1/immich/proxy/thumbnail/{{.ImmichPerson.ID}}" />
                                    </a>
                                </div>
                            </div>
                            <div class="ml-2">
                                <div class="font-bold text-base text-base-content/70"><a class="link" target="_blank" href="{{$.Base}}/people/{{.ImmichPerson.ID}}">{{.ImmichPerson.Name}}</a></div>
                                <div class="immich-birthdate text-sm font-bold font-mono {{if and .ImmichPerson.BirthDate (not .Contact.Birthday)}}text-error animate-pulse{{else}}opacity-60{{end}}">
                                    {{if .ImmichPerson.BirthDate}}{{.ImmichPerson.BirthDate}}{{else}}No Birthday Saved{{end}}
                                </div>
                            </div>
                        </div>
                    </td>

                    <td class="text-right py-8 pr-8">
                        <div class="flex justify-end items-center gap-2">
                            <div class="join border border-base-300 bg-base-100 shadow-sm p-2">
                                <button onclick="syncField('{{.Contact.ID}}', 'avatar', this)" 
                                        class="btn btn-ghost btn-md join-item px-3 hover:bg-success/10 hover:text-success tooltip" data-tip="Pull Immich Avatar">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                                </button>
                                <button onclick="syncField('{{.Contact.ID}}', 'birthday', this)" 
                                        class="btn btn-ghost btn-md join-item px-3 hover:bg-success/10 hover:text-success tooltip" data-tip="Pull Immich Birthday">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
                                </button>
                                <button onclick="unlinkImmich('{{.Contact.ID}}', '{{(index .Contact.URLs 0).ID}}')" 
                                        class="btn btn-ghost btn-md join-item px-3 hover:bg-error/10 hover:text-error tooltip" data-tip="Unlink">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m15 9-6 6"/><path d="m9 9 6 6"/><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></svg>
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {{else}}
                <tr>
                    <td colspan="4" class="text-center py-32 opacity-30 italic">
                        <div class="flex flex-col items-center gap-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M15 3v18"/><path d="m8 9 3 3-3 3"/></svg>
                            <p class="text-xl font-black">No Active Connections</p>
                        </div>
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
    </div>

    <div class="text-center pt-8">
        <div class="flex justify-center gap-4">
            <a href="/" class="btn btn-primary px-8">Return Home</a>
            <a href="/settings" class="btn btn-ghost">Settings</a>
        </div>
    </div>

</div>
{{end}}

{{define "scripts"}}
<script src="/static/js/util-immich.js"></script>
{{end}}