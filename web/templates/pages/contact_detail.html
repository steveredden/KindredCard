{{define "content"}}
<div class="max-w-7xl mx-auto">
    <!-- Breadcrumb -->
    <div class="text-sm breadcrumbs mb-6">
        <ul>
            <li><a href="/">Contacts</a></li>
            <li>{{.Contact.FullName}}</li>
        </ul>
    </div>

    <form id="contactForm" action="/contacts/{{.Contact.ID}}" method="POST" class="space-y-6">
        <!-- Header Section -->
        <div class="card bg-gradient-to-br from-primary to-secondary text-primary-content shadow-2xl">
            <div class="card-body">
                <div class="flex flex-col lg:flex-row gap-6 items-start">
                    
                    <!-- Avatar Upload -->
                    <div class="flex-shrink-0">
                        <div class="relative inline-block">

                            <!-- Avatar -->
                            <div class="avatar cursor-pointer" {{if .Contact.AvatarBase64}}onclick="openAvatarModal()"{{else}}onclick="document.getElementById('avatarInput').click()"{{end}}>
                                <div class="w-32 md:w-48 lg:w-48 rounded-full ring ring-primary-content ring-offset-base-100 ring-offset-4 overflow-hidden">

                                    {{if .Contact.AvatarBase64}}
                                    <!-- Real avatar -->
                                    <img id="avatarPreview" src="data:{{.Contact.AvatarMimeType}};base64,{{.Contact.AvatarBase64}}" alt="{{.Contact.FullName}}" class="object-cover w-full h-full" />
                                    {{else}}
                                    <!-- Fallback avatar -->
                                    <div class="flex flex-col h-full">

                                        <!-- Top 40%: black background + initials -->
                                        <div class="flex items-center justify-center h-[40%] bg-neutral text-neutral-content text-5xl font-bold -mt-[2px] pt-[2px]">
                                            {{if .Contact.GivenName}}{{initial .Contact.GivenName}}{{end}}{{if .Contact.FamilyName}}{{initial .Contact.FamilyName}}{{end}}
                                        </div>

                                        <!-- Bottom 60%: SVG -->
                                        <div class="flex items-center justify-center h-[60%]">
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-16 h-16 md:w-24 md:h-24 fill-current text-neutral">
                                                <path d="M4 3h13a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm1 2v14h12V5H5zm2 2h6v2H7V7zm0 4h8v2H7v-2zm0 4h6v2H7v-2z"/>
                                            </svg>
                                        </div>

                                    </div>
                                    {{end}}
                                </div>
                            </div>

                            <!-- Upload button (bottom-left) -->
                            <button 
                                type="button"
                                class="absolute bottom-0 left-0
                                        btn btn-md btn-circle
                                        bg-base-100 text-base-content
                                        border border-base-content/20
                                        hover:bg-base-200"
                                onclick="document.getElementById('avatarInput').click()"
                                title="Upload photo"
                            >
                                <!-- Upload SVG -->
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                    <polyline points="17 8 12 3 7 8"/>
                                    <line x1="12" y1="3" x2="12" y2="15"/>
                                </svg>
                            </button>

                            <!-- Delete button (bottom-right) -->
                            {{if .Contact.AvatarBase64}}
                            <button
                                type="button"
                                class="absolute bottom-0 right-0
                                        btn btn-md btn-circle
                                        bg-base-100 text-base-content
                                        border border-base-content/20
                                        hover:bg-base-200"
                                onclick="deleteAvatar()"
                                title="Remove photo"
                            >
                            <!-- X SVG -->
                                <svg
                                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="6" x2="6" y2="18"/>
                                    <line x1="6" y1="6" x2="18" y2="18"/>
                                </svg>
                            </button>
                            {{end}}
                        </div>

                        <!-- Hidden file input -->
                        <input
                            type="file"
                            id="avatarInput"
                            name="avatar"
                            accept="image/*"
                            class="hidden"
                            onchange="uploadAvatar()"
                        >
                    </div>

                    <!-- Name Section -->
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label"><span class="label-text text-primary-content">Prefix</span></label>
                            <input type="text" name="prefix" value="{{.Contact.Prefix}}" placeholder="Dr., Mr., Ms." class="input input-bordered bg-base-100 text-base-content">
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text text-primary-content">First Name *</span></label>
                            <input type="text" name="given_name" value="{{.Contact.GivenName}}" class="input input-bordered bg-base-100 text-base-content" required>
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text text-primary-content">Middle Name</span></label>
                            <input type="text" name="middle_name" value="{{.Contact.MiddleName}}" class="input input-bordered bg-base-100 text-base-content">
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text text-primary-content">Last Name</span></label>
                            <input type="text" name="family_name" value="{{.Contact.FamilyName}}" class="input input-bordered bg-base-100 text-base-content">
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text text-primary-content">Suffix</span></label>
                            <input type="text" name="suffix" value="{{.Contact.Suffix}}" placeholder="Jr., III, PhD" class="input input-bordered bg-base-100 text-base-content">
                        </div>
                        <div class="form-control">
                            <label class="label"><span class="label-text text-primary-content">Nickname</span></label>
                            <input type="text" name="nickname" value="{{.Contact.Nickname}}" class="input input-bordered bg-base-100 text-base-content">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card-actions justify-between mt-6">
                    <a href="/" class="btn btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Back to Contacts
                    </a>
                    <div class="flex gap-2">
                        <button type="button" class="btn btn-ghost" onclick="exportVCard({{.Contact.FullName}})">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Export vCard
                        </button>
                        <button type="submit" id="saveButton" class="btn btn-ghost" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                            Save Changes
                        </button>
                        <button type="button" class="btn btn-error" onclick="openDeleteModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column - Contact Details -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Phone Numbers -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">Phone Numbers</h2>
                        <div id="phonesList" class="space-y-3">
                            {{range $index, $phone := .Contact.Phones}}
                            <div class="flex gap-2 items-start">
                                <input type="tel" name="phones[{{$index}}][phone]" value="{{$phone.Phone}}" placeholder="(555) 123-4567" class="input input-bordered flex-1" required>
                                <select name="phones[{{$index}}][type]" class="select select-bordered">

                                    {{$types := $phone.Type}}
                                    {{$custom := isCustom $types}}
                                    {{if $custom}}
                                        <option value="{{$custom}}" selected>{{$custom}}</option>
                                    {{end}}

                                    <option value="cell" {{if hasType $phone.Type "cell"}}selected{{end}}>Cell</option>
                                    <option value="home" {{if hasType $phone.Type "home"}}selected{{end}}>Home</option>
                                    <option value="work" {{if hasType $phone.Type "work"}}selected{{end}}>Work</option>
                                    <option value="other" {{if hasType $phone.Type "other"}}selected{{end}}>Other</option>
                                </select>
                                <label class="label cursor-pointer gap-2">
                                    <input type="checkbox" name="phones[{{$index}}][is_primary]" class="checkbox checkbox-primary" {{if $phone.IsPrimary}}checked{{end}}>
                                    <span class="label-text">Primary</span>
                                </label>
                                <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="this.parentElement.remove(); markFormChanged();">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            {{end}}
                        </div>
                        <button type="button" class="btn btn-sm btn-ghost mt-2" onclick="addPhone()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Phone
                        </button>
                    </div>
                </div>

                <!-- Addresses -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">Addresses</h2>
                        <div id="addressesList" class="space-y-4">
                            {{range $index, $addr := .Contact.Addresses}}
                            <div class="card bg-base-200 shadow-md p-4">
                                <div class="flex justify-between items-start mb-3">
                                    <select name="addresses[{{$index}}][type]" class="select select-bordered select-sm">

                                    {{$types := $addr.Type}}
                                    {{$custom := isCustom $types}}
                                    {{if $custom}}
                                        <option value="{{$custom}}" selected>{{$custom}}</option>
                                    {{end}}

                                        <option value="home" {{if hasType $addr.Type "home"}}selected{{end}}>Home</option>
                                        <option value="work" {{if hasType $addr.Type "work"}}selected{{end}}>Work</option>
                                        <option value="other" {{if hasType $addr.Type "other"}}selected{{end}}>Other</option>
                                    </select>
                                    <div class="flex gap-2">
                                        <label class="label cursor-pointer gap-2">
                                            <input type="checkbox" name="addresses[{{$index}}][is_primary]" class="checkbox checkbox-primary checkbox-sm" {{if $addr.IsPrimary}}checked{{end}}>
                                            <span class="label-text">Primary</span>
                                        </label>
                                        <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="this.closest('.card').remove()">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <input type="text" name="addresses[{{$index}}][street]" value="{{$addr.Street}}" placeholder="Street Address" class="input input-bordered input-sm w-full">
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="text" name="addresses[{{$index}}][city]" value="{{$addr.City}}" placeholder="City" class="input input-bordered input-sm">
                                        <input type="text" name="addresses[{{$index}}][state]" value="{{$addr.State}}" placeholder="State" class="input input-bordered input-sm">
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="text" name="addresses[{{$index}}][postal_code]" value="{{$addr.PostalCode}}" placeholder="ZIP" class="input input-bordered input-sm">
                                        <input type="text" name="addresses[{{$index}}][country]" value="{{$addr.Country}}" placeholder="Country" class="input input-bordered input-sm">
                                    </div>
                                </div>
                            </div>
                            {{end}}
                        </div>
                        <button type="button" class="btn btn-sm btn-ghost mt-2" onclick="addAddress()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Address
                        </button>
                    </div>
                </div>

                <!-- Email Addresses -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">Email Addresses</h2>
                        <div id="emailsList" class="space-y-3">
                            {{range $index, $email := .Contact.Emails}}
                            <div class="flex gap-2 items-start">
                                <input type="email" name="emails[{{$index}}][email]" value="{{$email.Email}}" placeholder="email@example.com" class="input input-bordered flex-1" required>
                                <select name="emails[{{$index}}][type]" class="select select-bordered">

                                {{$types := $email.Type}}
                                {{$custom := isCustom $types}}
                                {{if $custom}}
                                    <option value="{{$custom}}" selected>{{$custom}}</option>
                                {{end}}

                                    <option value="home" {{if hasType $email.Type "home"}}selected{{end}}>Home</option>
                                    <option value="work" {{if hasType $email.Type "work"}}selected{{end}}>Work</option>
                                    <option value="other" {{if hasType $email.Type "other"}}selected{{end}}>Other</option>
                                </select>
                                <label class="label cursor-pointer gap-2">
                                    <input type="checkbox" name="emails[{{$index}}][is_primary]" class="checkbox checkbox-primary" {{if $email.IsPrimary}}checked{{end}}>
                                    <span class="label-text">Primary</span>
                                </label>
                                <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="this.parentElement.remove(); markFormChanged();">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            {{end}}
                        </div>
                        <button type="button" class="btn btn-sm btn-ghost mt-2" onclick="addEmail()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Email
                        </button>
                    </div>
                </div>

                <!-- Organizations -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">Organizations</h2>
                        <div id="orgsList" class="space-y-4">
                            {{range $index, $org := .Contact.Organizations}}
                            <div class="card bg-base-200 shadow-md p-4">
                                <div class="flex justify-end mb-2">
                                    <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="this.closest('.card').remove()">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <input type="text" name="organizations[{{$index}}][name]" value="{{$org.Name}}" placeholder="Company Name" class="input input-bordered input-sm">
                                    <input type="text" name="organizations[{{$index}}][title]" value="{{$org.Title}}" placeholder="Job Title" class="input input-bordered input-sm">
                                    <input type="text" name="organizations[{{$index}}][department]" value="{{$org.Department}}" placeholder="Department" class="input input-bordered input-sm col-span-2">
                                </div>
                            </div>
                            {{end}}
                        </div>
                        <button type="button" class="btn btn-sm btn-ghost mt-2" onclick="addOrganization()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Organization
                        </button>
                    </div>
                </div>

                <!-- Notes -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">Notes</h2>
                        <textarea name="notes" rows="6" class="textarea textarea-bordered" placeholder="Add notes about this contact...">{{.Contact.Notes}}</textarea>
                    </div>
                </div>
            </div>

            <!-- Right Column - Dates & Relationships -->
            <div class="space-y-6">

                <!-- Gender -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">Gender</h2>
                        <div class="form-control p-2">
                            <select name="gender" class="select select-bordered">
                                <option value="">Not specified</option>
                                <option value="M" {{if eq .Contact.Gender "M"}}selected{{end}}>Male</option>
                                <option value="F" {{if eq .Contact.Gender "F"}}selected{{end}}>Female</option>
                                <option value="O" {{if eq .Contact.Gender "O"}}selected{{end}}>Other</option>
                                <option value="N" {{if eq .Contact.Gender "N"}}selected{{end}}>Prefer not to say</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Important Dates -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">Important Dates</h2>
                        
                        <!-- Birthday -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Birthday</span>
                                <button type="button" class="btn btn-ghost btn-xs btn-circle" onclick="clearDate('birthday')" title="Clear birthday">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </label>
                            <div class="grid gap-2" style="grid-template-columns: 1fr 0.8fr 0.8fr;">
                                <select name="birthday_month" id="birthday_month" class="select select-bordered select-sm" data-date-group="birthday">
                                    <option value="">Month *</option>
                                    {{range $m := iterate 12}}
                                        <option value="{{$m}}" {{if and $.Birthday.Has (eq $.Birthday.Month $m)}}selected{{end}}>
                                            {{monthName $m}}
                                        </option>
                                    {{end}}
                                </select>
                                <select name="birthday_day" id="birthday_day" class="select select-bordered select-sm" data-date-group="birthday">
                                    <option value="">Day *</option>
                                    {{range $d := iterate 31}}
                                        <option value="{{$d}}" {{if and $.Birthday.Has (eq $.Birthday.Day $d)}}selected{{end}}>
                                            {{$d}}
                                        </option>
                                    {{end}}
                                </select>
                                <input type="number" name="birthday_year" id="birthday_year" placeholder="Year" min="1900" max="2100" 
                                       value="{{if .Contact.Birthday}}{{getYear .Contact.Birthday}}{{end}}" 
                                       class="input input-bordered input-sm">
                            </div>
                            <label class="label">
                                <span class="label-text-alt">Month and day are required. Year is optional.</span>
                            </label>
                        </div>

                        <!-- Anniversary -->
                        <div class="form-control mt-4">
                            <label class="label">
                                <span class="label-text font-semibold">Anniversary</span>
                                <button type="button" class="btn btn-ghost btn-xs btn-circle" onclick="clearDate('anniversary')" title="Clear anniversary">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </label>
                            <div class="grid gap-2" style="grid-template-columns: 1fr 0.8fr 0.8fr;">
                                <select name="anniversary_month" id="anniversary_month" class="select select-bordered select-sm" data-date-group="anniversary">
                                    <option value="">Month *</option>
                                    {{range $m := iterate 12}}
                                        <option value="{{$m}}" {{if and $.Anniversary.Has (eq $.Anniversary.Month $m)}}selected{{end}}>
                                            {{monthName $m}}
                                        </option>
                                    {{end}}
                                </select>
                                <select name="anniversary_day" id="anniversary_day" class="select select-bordered select-sm" data-date-group="anniversary">
                                    <option value="">Day *</option>
                                    {{range $d := iterate 31}}
                                        <option value="{{$d}}" {{if and $.Anniversary.Has (eq $.Anniversary.Day $d)}}selected{{end}}>
                                            {{$d}}
                                        </option>
                                    {{end}}
                                </select>
                                <input type="number" name="anniversary_year" id="anniversary_year" placeholder="Year" min="1900" max="2100" 
                                       value="{{if .Contact.Anniversary}}{{getYear .Contact.Anniversary}}{{end}}" 
                                       class="input input-bordered input-sm">
                            </div>
                            <label class="label">
                                <span class="label-text-alt">Month and day are required. Year is optional.</span>
                            </label>
                        </div>

                        <!-- Other Dates -->
                        <div class="mt-6">
                            <h3 class="font-semibold mb-3">Other Dates</h3>
                            <div id="otherDatesList" class="space-y-3">
                                {{range $index, $dateView := .OtherDates}}
                                <div class="flex gap-2 items-start border-l-4 border-primary pl-3">
                                    <div class="flex-1 space-y-2">
                                        <input type="text" name="other_dates[{{$index}}][event_name]" value="{{$dateView.EventName}}" placeholder="Event name" class="input input-bordered input-sm w-full" required>
                                        <div class="grid gap-2" style="grid-template-columns: 1fr 0.8fr 0.8fr;">
                                            <select name="other_dates[{{$index}}][event_date_month]" class="select select-bordered select-sm" data-date-group="other_dates_{{$index}}">
                                                <option value="">Month *</option>
                                                {{range $m := iterate 12}}
                                                    <option value="{{$m}}" {{if and $dateView.Date.Has (eq $dateView.Date.Month $m)}}selected{{end}}>
                                                        {{monthNameShort $m}}
                                                    </option>
                                                {{end}}
                                            </select>
                                            <select name="other_dates[{{$index}}][event_date_day]" class="select select-bordered select-sm" data-date-group="other_dates_{{$index}}">
                                                <option value="">Day *</option>
                                                {{range $d := iterate 31}}
                                                <option value="{{$d}}" {{if and $dateView.Date.Has (eq $dateView.Date.Day $d)}}selected{{end}}>{{$d}}</option>
                                                {{end}}
                                            </select>
                                            <input type="number" name="other_dates[{{$index}}][event_date_year]" placeholder="Year" min="1900" max="2100" 
                                                   value="{{if gt $dateView.Year 0}}{{$dateView.Year}}{{end}}" 
                                                   class="input input-bordered input-sm">
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="this.parentElement.remove(); markFormChanged();" title="Delete event">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                {{end}}
                            </div>
                            <button type="button" class="btn btn-sm btn-ghost mt-2" onclick="addOtherDate()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                                Add Other Date
                            </button>
                        </div>
                        
                    </div>
                </div>

                <!-- Relationships -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">Relationships</h2>
                        
                        <div id="relationshipsList" class="space-y-3">
                            {{range .Contact.Relationships}}
                            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                                <div>
                                    <div class="badge badge-primary">{{.RelationshipType.Name}}</div>
                                    <a href="/contacts/{{.RelatedContactID}}" class="link link-hover ml-2">
                                        {{if .RelatedContact.FullName}}{{.RelatedContact.FullName}}{{else}}{{.Contact.FullName}}{{end}}
                                    </a>
                                </div>
                                <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="removeRelationship({{.ID}})">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            {{end}}
                            {{range .Contact.OtherRelationships}}
                            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                                <div>
                                    <div class="badge badge-secondary">{{.RelationshipName}}*</div>
                                    <a href="#" class="link link-hover ml-2">
                                        {{.RelatedContactName}}
                                    </a>
                                </div>
                                <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="removeOtherRelationship({{.ID}})">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            {{end}}
                        </div>

                        <button type="button" class="btn btn-sm btn-ghost mt-2" onclick="openAddRelationshipModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Relationship
                        </button>
                    </div>
                </div>

                <!-- URLs -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">Websites</h2>
                        <div id="urlsList" class="space-y-3">
                            {{range $index, $url := .Contact.URLs}}
                            <div class="flex gap-2 items-center">
                                <input type="url" name="urls[{{$index}}][url]" value="{{$url.URL}}" placeholder="https://example.com" class="input input-bordered input-sm flex-1">
                                <select name="urls[{{$index}}][type]" class="select select-bordered select-sm">

                                {{$types := $url.Type}}
                                {{$custom := isCustom $types}}
                                {{if $custom}}
                                    <option value="{{$custom}}" selected>{{$custom}}</option>
                                {{end}}

                                    <option value="website" {{if hasType $url.Type "website"}}selected{{end}}>Website</option>
                                    <option value="social" {{if hasType $url.Type "social"}}selected{{end}}>Social</option>
                                    <option value="other" {{if hasType $url.Type "other"}}selected{{end}}>Other</option>
                                </select>
                                <button type="button" class="btn btn-ghost btn-sm btn-square" onclick="this.parentElement.remove(); markFormChanged();">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            {{end}}
                        </div>
                        <button type="button" class="btn btn-sm btn-ghost mt-2" onclick="addURL()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Website
                        </button>
                    </div>
                </div>

                <!-- Metadata -->
                <div class="card bg-base-100 shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title">Miscellaneous</h2>
                        <div class="form-control p-2">
                            <label class="label cursor-pointer gap-1">
                                <span class="label-text m-0 p-0">Exclude from CardDAV Server?</span>
                                <input type="checkbox" name="exclude_from_sync" class="checkbox checkbox-primary" {{if .Contact.ExcludeFromSync}}checked{{end}}>
                            </label>
                        </div>
                        <div class="text-sm space-y-1">
                            <div><strong>Created:</strong> {{.Contact.CreatedAt.Format "January 2, 2006"}}</div>
                            <div><strong>Updated:</strong> {{.Contact.UpdatedAt.Format "January 2, 2006"}}</div>
                            <div class="text-xs opacity-70">ID: {{.Contact.ID}} | UID: {{.Contact.UID}}</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>


{{template "avatar_modal" .}}
{{template "add_relationship_modal" .}}
{{template "delete_conf_modal" .}}
{{end}}

{{define "scripts"}}
<script src="/static/js/contact-detail.js"></script>
{{end}}
